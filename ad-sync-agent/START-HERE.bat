@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

REM ========================================
REM AD Sync Agent - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê
REM ========================================
title AD Sync Agent - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

color 0A
echo.
echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
echo ‚ïë   AD Sync Agent - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê              ‚ïë
echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
echo.

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo [‚ùå] Python –Ω–µ –Ω–∞–π–¥–µ–Ω!
    echo.
    echo üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Python –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...
    echo.
    echo –û—Ç–∫—Ä–æ–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Python.
    echo –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Python –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å–Ω–æ–≤–∞.
    echo.
    start https://www.python.org/downloads/
    pause
    exit /b 1
)

echo [‚úÖ] Python –Ω–∞–π–¥–µ–Ω
python --version

REM –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo.
echo üì¶ –ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
pip show ldap3 >nul 2>&1
if %errorlevel% neq 0 (
    echo     –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python...
    pip install -q -r requirements.txt
    echo [‚úÖ] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
) else (
    echo [‚úÖ] –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
)

REM –°–æ–∑–¥–∞—ë–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if not exist .env (
    echo.
    echo üìù –°–æ–∑–¥–∞—é —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...
    copy .env.example .env >nul
    echo [‚úÖ] –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω
)

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ .env
findstr /C:"your-" .env >nul 2>&1
if %errorlevel% equ 0 (
    echo.
    echo ‚ö†Ô∏è  –§–∞–π–ª .env –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å!
    echo.
    echo üîß –û—Ç–∫—Ä—ã–≤–∞—é —Ñ–∞–π–ª .env –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...
    echo.
    echo üìã –í–ê–ñ–ù–û: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:
    echo    - AD_HOST - –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ AD —Å–µ—Ä–≤–µ—Ä–∞
    echo    - AD_USERNAME - —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è AD
    echo    - AD_PASSWORD - –ø–∞—Ä–æ–ª—å
    echo    - AD_BASE_DN - –±–∞–∑–æ–≤—ã–π DN (–Ω–∞–ø—Ä–∏–º–µ—Ä: DC=domain,DC=local)
    echo    - PLATFORM_URL - URL –≤–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    echo    - TENANT_ID - ID –≤–∞—à–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
    echo    - API_KEY - API –∫–ª—é—á (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ AD Sync –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ)
    echo.
    echo –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É...
    echo.
    notepad .env
    echo.
)

REM –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â—ë —Ä–∞–∑
findstr /C:"your-" .env >nul 2>&1
if %errorlevel% equ 0 (
    echo [‚ùå] –§–∞–π–ª .env –≤—Å—ë –µ—â—ë —Å–æ–¥–µ—Ä–∂–∏—Ç —à–∞–±–ª–æ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è!
    echo     –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–µ .env
    pause
    exit /b 1
)

echo.
echo ========================================
echo üöÄ –ó–ê–ü–£–°–ö –ê–ì–ï–ù–¢–ê
echo ========================================
echo.
echo ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞!
echo ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!
echo.
echo üì° –ê–≥–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...
echo.
echo –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C
echo.
echo ========================================
echo.

REM –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞
python ad_sync_agent.py

pause

